<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Attendance System</title>
  <!-- ADD THESE PWA META TAGS -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#007BFF">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Attendance App">
  <meta name="description" content="Face Recognition & QR Code Attendance System">

  <!-- PWA MANIFEST -->
  <link rel="manifest" href="/static/manifest.json">
  
  <!-- APPLE TOUCH ICONS -->
  <link rel="apple-touch-icon" sizes="192x192" href="/static/icon-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="/static/icon-512.png">
  
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
  <video id="video" width="480" height="360" autoplay playsinline style="display:none;"></video>
  <canvas id="canvas" width="480" height="360" style="display:none;"></canvas>
  <canvas id="overlayCanvas" width="480" height="360" style="display:none;"></canvas>
  
  <!-- Install PWA Button (optional) -->
  <button id="installBtn" style="display:none; position:fixed; bottom:20px; right:20px; z-index:1000; background:#007BFF; color:white; border:none; padding:10px 15px; border-radius:25px; cursor:pointer;">
    ðŸ“± Install App
  </button>
  

  <div class="modal-overlay" id="qrModal">
    <div class="modal-content">
      <h3 id="qrModalTitle">Student Enrolled!</h3>
      <img id="qrModalImage" src="" alt="QR Code">
      <br>
      <button class="btn primary" onclick="closeQrModal()">Close</button>
    </div>
  </div>

  <div class="main-view" id="mainView"></div>

  <template id="createAccount-template">
    <div class="container" id="createAccount">
      <h2>Create Account</h2>
      <div class="form">
        <input type="text" id="regName" placeholder="Username">
        <input type="password" id="regPass" placeholder="Password">
        <input type="password" id="regCPass" placeholder="Confirm Password">
        <button class="btn primary" onclick="register()">Register</button>
      </div>
      <div class="link" onclick="showPage('loginPage')">Already have an account? <span>Login</span></div>
    </div>
  </template>
  <template id="loginPage-template">
    <div class="container" id="loginPage">
      <h2>Login</h2>
      <div class="form">
        <input type="text" id="loginName" placeholder="Username">
        <input type="password" id="loginPass" placeholder="Password">
        <button class="btn primary" onclick="login()">Login</button>
      </div>
      <div class="link" onclick="showPage('createAccount')">Donâ€™t have an account? <span>Create one</span></div>
    </div>
  </template>
  <template id="dashboard-template">
    <div class="container" id="dashboard">
      <h2>Dashboard</h2>
      <div class="actions">
        <button class="btn secondary" onclick="showPage('registerStudent')">Register New Student</button>
        <button class="btn secondary" onclick="showPage('attendanceRecord')">View Attendance</button>
        <button class="btn secondary" onclick="showPage('liveAttendancePage')">Live Attendance</button>
        <button class="btn secondary" onclick="showPage('qrScannerPage')">Scan QR Code</button>
        <button class="btn secondary" onclick="showPage('analyticsPage')">View Analytics</button>
        <button class="btn danger" onclick="logout()">Logout</button>
      </div>
    </div>
  </template>
  <template id="registerStudent-template">
    <div class="container" id="registerStudent">
      <h2>Register Student</h2>
      <div id="webcam-container" class="camera-container"></div>
      <div class="form">
        <input type="text" id="stuName" placeholder="Student Name (No Spaces, e.g., JohnDoe)">
        <button class="btn secondary" onclick="startEnrollmentCamera()">Start Camera</button>
        <button class="btn primary" onclick="saveStudent()">Capture & Save Student</button>
      </div>
      <div class="link" onclick="stopCamera(); showPage('dashboard');">â¬… Back to Dashboard</div>
    </div>
  </template>
  <template id="liveAttendancePage-template">
    <div class="container" id="liveAttendancePage">
      <h2>Live Attendance</h2>
      <div id="live-webcam-container" class="camera-container"></div>
      <div id="recognition-status" style="text-align: center; font-size: 1.2em; font-weight: bold; min-height: 30px; padding-top: 10px;"></div>
      <div class="link" onclick="stopCamera(); showPage('dashboard');">â¬… Back to Dashboard</div>
    </div>
  </template>
  <template id="qrScannerPage-template">
    <div class="container" id="qrScannerPage">
      <h2>Scan Student QR Code</h2>
      <div id="qr-reader"></div>
      <div id="qr-scan-result" style="text-align:center; margin-top:15px; font-weight:bold;"></div>
      <div class="link" onclick="stopQrScanner(); showPage('dashboard');">â¬… Back to Dashboard</div>
    </div>
  </template>
  
  <template id="analyticsPage-template">
    <div id="analyticsPage">
      <div class="sidebar">
        <h2>Analytics Dashboard</h2>
        
        <div class="filter-group">
          <label for="studentFilter">Filter by Student</label>
          <select id="studentFilter">
            <option value="">All Students</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="startDate">Start Date</label>
          <input type="date" id="startDate">
        </div>
        <div class="filter-group">
          <label for="endDate">End Date</label>
          <input type="date" id="endDate">
        </div>
        
        <button class="btn primary" onclick="applyAnalyticsFilters()">Apply Filters</button>
        <button class="btn secondary" onclick="resetAnalyticsFilters()">Reset</button>

        <hr style="margin: 20px 0;">
        
        <button class="btn danger" onclick="exportAnalyticsToCSV()">Export Data to CSV</button>

        <div class="link" style="margin-top: auto;" onclick="showPage('dashboard')">â¬… Back to Dashboard</div>
      </div>
      <div class="main-content">
        <div class="kpi-grid">
          <div class="stat-card"><h3>Students Present</h3><p id="totalStudents">0</p></div>
          <div class="stat-card"><h3>Total Records</h3><p id="totalRecords">0</p></div>
          <div class="stat-card"><h3>Busiest Day</h3><p id="busiestDay" style="font-size: 1.2em;">N/A</p></div>
        </div>

        <div class="chart-grid">
            <div class="chart-container"><h3>Attendance by Source</h3><canvas id="sourceChart"></canvas></div>
            <div class="chart-container"><h3>Attendance Trend by Date</h3><canvas id="dateChart"></canvas></div>
        </div>

        <div class="chart-container">
          <h3>Attendance Percentage per Student</h3>
          <canvas id="studentChart"></canvas>
        </div>
        <div class="chart-container">
          <h3>Detailed Log</h3>
          <div style="max-height: 300px; overflow-y: auto;">
            <table id="detailsTable">
              <thead><tr><th>ID</th><th>Name</th><th>Date</th><th>Timestamp</th><th>Source</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </template>

  <template id="attendanceRecord-template">
    <div class="container" id="attendanceRecord">
      <h2>Attendance Record</h2>
      <table id="attendance-table">
        <thead><tr><th>ID</th><th>Name</th><th>Date</th><th>Status</th><th>Timestamp</th><th>Source</th></tr></thead>
        <tbody id="attendanceTable"></tbody>
      </table>
      <div class="link" onclick="showPage('dashboard')">â¬… Back to Dashboard</div>
    </div>
  </template>

  <!-- PWA SERVICE WORKER REGISTRATION -->
  <script>
    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/static/sw.js')
          .then(registration => console.log('SW registered'))
          .catch(error => console.log('SW registration failed'));
      });
    }

    // PWA Install Prompt
    let deferredPrompt;
    const installBtn = document.getElementById('installBtn');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'block';
    });

    installBtn.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
          installBtn.style.display = 'none';
        }
        deferredPrompt = null;
      }
    });

    // Hide install button if already installed
    window.addEventListener('appinstalled', () => {
      installBtn.style.display = 'none';
    });
  </script>

  <script src="/static/script.js" defer></script>
</body>
</html>